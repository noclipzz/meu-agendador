datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// --- EMPRESA (SaaS Multi-tenant) ---
model Company {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  ownerId   String   @unique
  createdAt DateTime @default(now())

  // Configura√ß√µes e Branding
  logoUrl                      String? @default("")
  openTime                     String  @default("09:00")
  closeTime                    String  @default("18:00")
  lunchStart                   String  @default("12:00")
  lunchEnd                     String  @default("13:00")
  interval                     Int     @default(30)
  workDays                     String  @default("1,2,3,4,5")
  monthlyGoal                  Decimal @default(5000)
  whatsappMessage              String? @default("Ol√° {nome}, recebemos seu agendamento para *{servico}* em {dia} √†s {hora}.\n\nDigite *1* para Confirmar ou *2* para Cancelar.")
  whatsappConfirmMessage       String? @default("‚úÖ *Agendamento Confirmado!*\n\n{nome}, seu hor√°rio para *{servico}* est√° garantido. At√© l√°!")
  whatsappCancelPromptMessage  String? @default("‚ö†Ô∏è *Confirma√ß√£o de Cancelamento*\n\n{nome}, voc√™ deseja realmente *CANCELAR* seu hor√°rio de *{servico}*?\n\nResponda *SIM* para confirmar o cancelamento definitivo.")
  whatsappCancelSuccessMessage String? @default("‚ùå *Agendamento Cancelado*\n\nSeu agendamento foi cancelado com sucesso.")
  whatsappCancelRevertMessage  String? @default("Entendido! Mantivemos seu agendamento como *Pendente*. Caso deseje confirmar, digite *Sim*.")
  whatsappWaitingListMessage   String? @default("Ol√° {nome}, uma vaga surgiu para o dia {dia}! üéâ\n\nToque no link abaixo para garantir seu hor√°rio:\n{link}")
  notificationEmail            String?
  instagramUrl                 String? @default("")
  facebookUrl                  String? @default("")

  // --- INTEGRA√á√ÉO WHATSAPP (Evolution API) ---
  whatsappInstanceId String? // Nome da inst√¢ncia na VPS (Ex: 'nohud-wpp')
  whatsappStatus     String? @default("DISCONNECTED") // CONNECTING, CONNECTED, DISCONNECTED
  evolutionServerUrl String? // URL da VPS (Ex: 'http://123.45.67.89:8080')
  evolutionApiKey    String? // Chave Global da VPS
  whatsappQrCode     String? @db.Text // QR Code base64 recebido via webhook

  // Dados de Endere√ßo e Contato (Novo)
  cnpj         String?
  phone        String?
  cep          String?
  address      String?
  number       String?
  complement   String?
  neighborhood String?
  city         String?
  state        String?

  // --- DADOS FISCAIS (Focus NFe) ---
  inscricaoMunicipal String?
  regimeTributario   Int?     @default(1) // 1: Simples Nacional, 3: Normal
  naturezaOperacao   Int?     @default(1) // 1: Tributa√ß√£o no munic√≠pio
  codigoServico      String? // C√≥digo da lista de servi√ßos (ex: 07.02)
  aliquotaServico    Decimal? @default(0)
  certificadoA1Url   String?
  certificadoSenha   String?

  // --- CONFIGURA√á√ïES DE TAXAS ---
  creditCardTax Decimal? @default(0)
  debitCardTax  Decimal? @default(0)

  // Rela√ß√µes
  services      Service[]
  bookings      Booking[]
  professionals Professional[]
  teamMembers   TeamMember[]
  clients       Client[]
  expenses      Expense[]
  invoices      Invoice[]
  products      Product[] // Estoque da empresa
  formTemplates FormTemplate[] // Templates de prontu√°rio
  waitingList   WaitingList[] // Lista de espera
  posts         OrganizationPost[] // Mural de Avisos
}

// --- MURAL DE AVISOS (REDE SOCIAL CORPORATIVA) ---
model OrganizationPost {
  id       String  @id @default(cuid())
  title    String
  content  String
  type     String  @default("AVISO") // AVISO, EVENTO, URGENTE, CELEBRACAO
  imageUrl String?

  authorId   String? // Clerk User ID de quem postou
  authorName String? // Nome cacheado para exibi√ß√£o r√°pida

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- MEMBROS DA EQUIPE ---
model TeamMember {
  id          String  @id @default(cuid())
  clerkUserId String? @unique
  email       String  @unique
  role        String  @default("PROFESSIONAL") // ADMIN ou PROFESSIONAL
  permissions Json? // Controle granular: { "dashboard": boolean, "agenda": boolean, ... }

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

// --- PROFISSIONAIS ---
model Professional {
  id       String  @id @default(cuid())
  name     String
  photoUrl String?
  phone    String?
  email    String? // <-- Adicionado para v√≠nculo com TeamMember
  color    String  @default("#3b82f6")
  userId   String? @unique

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  bookings    Booking[]
  waitingList WaitingList[]

  // Dados completos (Espelho do Cliente)
  cpf           String?
  rg            String?
  birthDate     String?
  cep           String?
  address       String?
  number        String?
  complement    String?
  neighborhood  String?
  city          String?
  state         String?
  notes         String?
  maritalStatus String?
  status        String  @default("ATIVO")

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  services    Service[] // Services performed by this professional
  attachments Attachment[]
}

// --- SERVI√áOS ---
model Service {
  id          String  @id @default(cuid())
  name        String
  description String?
  price       Decimal
  duration    Int
  commission  Int     @default(0)

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  bookings    Booking[]
  waitingList WaitingList[]

  // Produtos consumidos por este servi√ßo (Receita)
  products ServiceProduct[]

  // Quem realiza
  professionals Professional[]
}

// --- DESPESAS (CONTAS A PAGAR) ---
model Expense {
  id          String   @id @default(cuid())
  description String
  value       Decimal
  category    String
  frequency   String   @default("ONCE")
  date        DateTime @default(now())

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

// --- FATURAS E COBRAN√áAS (CONTAS A RECEBER) ---
model Invoice {
  id          String   @id @default(cuid())
  description String
  value       Decimal
  cardTax     Decimal? @default(0) // Valor da taxa descontado
  netValue    Decimal? @default(0) // Valor l√≠quido (bruto - taxa)
  method      String? // PIX, BOLETO, CARTAO, DINHEIRO, FATURADO
  status      String   @default("PENDENTE") // PENDENTE, PAGO, VENCIDO, CANCELADO

  dueDate DateTime // Data de vencimento da cobran√ßa
  paidAt  DateTime? // Data em que o pagamento foi confirmado

  // V√≠nculos
  bookingId String?  @unique
  booking   Booking? @relation(fields: [bookingId], references: [id])

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id], onDelete: Cascade)

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- AGENDAMENTOS E EVENTOS ---
model Booking {
  id            String   @id @default(cuid())
  date          DateTime
  customerName  String
  customerPhone String?
  userId        String?

  type     String  @default("CLIENTE") // CLIENTE, EVENTO ou ENCAIXE
  location String?

  status       String  @default("PENDENTE") // PENDENTE, CONFIRMADO, CONCLUIDO, CANCELADO
  reminderSent Boolean @default(false)

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id])

  serviceId String?
  service   Service? @relation(fields: [serviceId], references: [id])

  professionalId String?
  professional   Professional? @relation(fields: [professionalId], references: [id])

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  invoice Invoice?
}

// --- ASSINATURAS (Stripe) ---
model Subscription {
  id     String  @id @default(cuid())
  userId String  @unique
  plan   String?
  status String  @default("INACTIVE")

  stripeCustomerId     String?   @unique
  stripeSubscriptionId String?   @unique
  stripePriceId        String?
  expiresAt            DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- CLIENTES (CRM) ---
model Client {
  id            String  @id @default(cuid())
  name          String
  phone         String?
  email         String?
  clientType    String  @default("FISICA") // FISICA ou JURIDICA
  cpf           String?
  cnpj          String?
  rg            String?
  inscricaoEstadual String?
  birthDate     String?
  cep           String?
  address       String?
  number        String?
  complement    String?
  neighborhood  String?
  city          String?
  state         String?
  notes         String?
  maritalStatus String?
  photoUrl      String?
  status        String  @default("ATIVO")

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  bookings    Booking[]
  attachments Attachment[]
  invoices    Invoice[]
  formEntries FormEntry[] // Prontu√°rios preenchidos
  createdAt   DateTime     @default(now())
}

model Attachment {
  id   String @id @default(cuid())
  name String
  url  String
  type String // Ex: image/png, application/pdf
  size Int    @default(0) // Tamanho em bytes

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id], onDelete: Cascade)

  professionalId String?
  professional   Professional? @relation(fields: [professionalId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

// --- NOVO: ESTOQUE AVAN√áADO (COM LOTES) ---

model Product {
  id        String   @id @default(cuid())
  name      String
  // quantity agora √© a SOMA de todos os lotes (cache para performance)
  quantity  Decimal  @default(0)
  unit      String   @default("UN")
  minStock  Decimal  @default(5)
  costPrice Decimal? @default(0)

  // Removemos expiryDate daqui, pois agora cada lote tem a sua

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  batches        ProductBatch[] // <--- NOVOS LOTES
  usedInServices ServiceProduct[]
  logs           StockLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// NOVA TABELA: LOTES DE PRODUTO
model ProductBatch {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  quantity   Decimal // Quantidade neste lote espec√≠fico
  expiryDate DateTime? // Validade deste lote espec√≠fico
  createdAt  DateTime  @default(now())
}

model StockLog {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  quantity Decimal
  oldStock Decimal
  newStock Decimal
  type     String // "ENTRADA", "SAIDA", "AJUSTE", "VENDA"
  reason   String?

  createdAt DateTime @default(now())
}

// Mantenha o ServiceProduct igual...
model ServiceProduct {
  id        String  @id @default(cuid())
  serviceId String
  service   Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  amount    Decimal

  @@unique([serviceId, productId])
}

// --- PRONTU√ÅRIOS PERSONALIZ√ÅVEIS ---

model FormTemplate {
  id          String  @id @default(cuid())
  name        String
  description String?
  fields      Json // Array de defini√ß√µes de campos

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  entries FormEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- NOVO: LISTA DE ESPERA (SMART FILL) ---
model WaitingList {
  id            String    @id @default(cuid())
  customerName  String
  customerPhone String
  preferences   String? // Ex: "Segundas e Quartas, Manh√£"
  desiredDate   DateTime? // Data que o cliente queria
  status        String    @default("ATIVO") // ATIVO, ATENDIDO, CANCELADO

  serviceId String?
  service   Service? @relation(fields: [serviceId], references: [id])

  professionalId String?
  professional   Professional? @relation(fields: [professionalId], references: [id])

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String   @unique
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())
}

model FormEntry {
  id   String @id @default(cuid())
  data Json // Dados preenchidos do formul√°rio

  templateId String
  template   FormTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  companyId String
  filledBy  String? // userId de quem preencheu

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
